# Code Generation Tool for Default Configuration

This directory contains a `go generate` tool that converts TOML configuration files into compile-time Go struct literals, eliminating runtime TOML parsing overhead.

## Purpose

Instead of parsing `config.default.toml` and `rules.default.toml` at runtime using `toml.Unmarshal()`, this tool generates Go source code with pre-initialized struct values at compile time.

## Usage

### Automatic (Recommended)

```bash
cd internal/config
go generate
```

This runs the generator as specified by the `//go:generate` directive in `defaults.go`.

### Manual

```bash
go run internal/config/tools/gendefaults/main.go internal/config
```

## Generated Output

The tool creates `internal/config/defaults_generated.go` containing:

- `PreparsedDefaultConfig Config` - Pre-parsed default configuration
- `PreparsedDefaultRules Rules` - Pre-parsed default rules

## Features

### Supported Types

- **Primitives**: bool, int, uint, float, string
- **Collections**: slices, maps (with sorted keys for deterministic output)
- **Nested structs**: full recursive support
- **Interfaces**: interface{} values with concrete type preservation

### Smart Output

- Zero-value fields are omitted for cleaner code
- Map keys are sorted alphabetically for reproducible builds
- Generated code is formatted with `go fmt`
- Type names are preserved from source structs

## Build Process Impact

### Minimal Complexity

1. **No new dependencies** - Uses only standard library + existing `go-toml` dependency
2. **Optional step** - Generated file is committed to repo, regeneration only needed when defaults change
3. **Standard Go workflow** - Uses conventional `go generate` pattern

### When to Regenerate

Run `go generate` in `internal/config/` when:
- `config.default.toml` is modified
- `rules.default.toml` is modified
- Config struct definitions change

## Performance Benefits

**Before:**
```go
var cfg Config
toml.Unmarshal([]byte(DefaultConfigTOML), &cfg)  // Runtime parsing
```

**After:**
```go
cfg := PreparsedDefaultConfig  // Zero-cost copy
```

This eliminates:
- TOML parser overhead on every startup
- Memory allocations during parsing
- Potential parsing errors at runtime

## Implementation Details

The generator uses Go's `reflect` package to recursively traverse struct values and emit valid Go literal syntax. It handles all standard Go types and produces formatted, idiomatic code.

### Type Duplication

The generator tool duplicates type definitions from `internal/config` to avoid circular dependencies. These definitions must be kept in sync manually when config structures change.

## Example Output

```go
// Code generated by go generate; DO NOT EDIT.
package config

var PreparsedDefaultConfig = Config{
    SetProxy: true,
    ImportCA: "auto",
    IPv6:     true,
    DNS: DNSConfig{
        Nameserver:   []string{"https://dns.google/dns-query"},
        BootstrapDNS: []string{"tls://223.5.5.5"},
    },
    Server: ServerConfig{
        Address: "127.0.0.1",
        Port:    7654,
    },
}
```
